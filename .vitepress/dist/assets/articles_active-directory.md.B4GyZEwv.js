import{_ as t,c as i,o as s,af as r}from"./chunks/framework.CgkrJXe5.js";const n="/medias/articles/active-directory/image-2.png",v=JSON.parse('{"title":"Active Directory","description":"Avant de commencer à parler d’exploitation de vulnérabilités en environnement Active Directory il est important de savoir de quoi il s’agit.","frontmatter":{"title":"Active Directory","date":"2022-11-26","description":"Avant de commencer à parler d’exploitation de vulnérabilités en environnement Active Directory il est important de savoir de quoi il s’agit.","categories":["active-directory"],"image":"/medias/articles/active-directory/active-directory-logo.png"},"headers":[],"relativePath":"articles/active-directory.md","filePath":"articles/active-directory.md"}'),a={name:"articles/active-directory.md"};function o(u,e,l,d,p,c){return s(),i("div",null,e[0]||(e[0]=[r('<p>Avant de commencer à parler d&#39;exploitation de vulnérabilités en environnement Active Directory il est important de savoir de quoi il s&#39;agit.</p><h3 id="historique" tabindex="-1">Historique <a class="header-anchor" href="#historique" aria-label="Permalink to &quot;Historique&quot;">​</a></h3><p>L’environnement &quot;AD&quot; à été initié en 1996 par Microsoft et est disponible depuis 1999. L&#39;objectif de cet équipement est de proposer un annuaire LDAP dans l’environnement Microsoft. Ces derniers ayant une grande part de marché dans les entreprises cette implémentation &quot;maison&quot; est logique car elle permet de proposer de nombreuses fonctionnalités d&#39;administration et de segmentation.</p><p>Et bien que les chapitres qui vont survient traitent de vulnérabilités relatives à des défauts de configuration il est important de noter qu&#39;un Active Directory bien configuré et durci est un élément important de la sécurité d&#39;un Système d&#39;Information.</p><p>La fonctionnalité AD s&#39;installe sur une version &quot;Server&quot; de Windows, généralement celui-ci se nomme &quot;Contrôleur de Domaine&quot; . De nombreuses versions d&#39;Active Directory ont été proposées par Microsoft depuis sa sortie initiale chacune apportant son lot de nouveautés.</p><p>Il est donc possible que vous rencontriez les versions suivantes :</p><ul><li>Windows 2000 Server Edition</li><li>Windows Server 2003</li><li>Windows Server 2008</li><li>Windows Server 2008 R2</li><li>Windows Server 2012</li><li>Windows Server 2012 R2</li><li>Windows Server 2016</li><li>Windows Server 2019</li><li>Windows Server 2022</li></ul><p>Pour les plus anciennes d&#39;entre elles, je pense que vous n&#39;aurez pas trop de difficultés à trouver des vulnérabilités connues et souvent référencés dans Metasploit. Enfin, certaines implémentations &quot;Exotiques&quot; existent, mais il n&#39;en sera pas questions ici.</p><p>Petite anecdote sur le <em>naming</em>, au tout départ celui-ci devait s&#39;appeler NT Discovery Services (NTDS), ce nom se retrouvera notamment au niveau du fichier stockant les empreintes de mots de passes des utilisateurs : NTDS.DIT ( équivalent d&#39;une base SAM sur un AD). Un fichier que nous allons chercher à récupérer.</p><h3 id="lexique" tabindex="-1">Lexique <a class="header-anchor" href="#lexique" aria-label="Permalink to &quot;Lexique&quot;">​</a></h3><p>Pour la suite des événements nous allons utiliser un lexique classique dans cet environnement, mais qui peut paraître complexe.</p><h4 id="un-objet" tabindex="-1">Un objet <a class="header-anchor" href="#un-objet" aria-label="Permalink to &quot;Un objet&quot;">​</a></h4><p>Un AD permet de stocker des informations sur le domaine, pour cela, les éléments à administrer sont classés en catégories d&#39;&quot;objets&quot;. Chaque objet est une entité administrable. Parmi ces objets on retrouve:</p><ul><li>OU ( Organisational Unit : Utilisés pour effectuer des délégations de droits, une sorte de &quot;groupe d&#39;objets&quot; à ne pas confondre avec l&#39;objet Groupe)</li><li>Des ordinateurs</li><li>Des utilisateurs</li><li>Des groupes ( D&#39;ordinateur et / ou d&#39;utilisateurs ), souvent utilisés pour attribuer des droits à un ensemble d&#39;utilisateurs regroupés</li></ul><h4 id="derriere-les-arbres-la-foret" tabindex="-1">Derrière les arbres, la foret <a class="header-anchor" href="#derriere-les-arbres-la-foret" aria-label="Permalink to &quot;Derrière les arbres, la foret&quot;">​</a></h4><p>La première fois que j&#39;ai entendu parler de &quot;Foret&quot; je me suis demandé si ce n&#39;était pas une blague, et pourtant, l&#39;explication est bien plus simple en Français.</p><p>Les objets d&#39;un Active Directory sont classés en fonction d&#39;une hiérarchie, ce qui permet d&#39;introduire des héritages de droits. Un AD, hébergeant un &quot;Domaine&quot;, permet utilise ces concepts de hiérarchie afin d&#39;établir une arborescence de privilèges.</p><p>De plus, une organisation peut avoir plusieurs AD au sein de son réseau, c&#39;est souvent le cas des établissement qui se regroupent suite à des rachats. Pour distinguer les emplacement de chaque ressource, AD se base sur le DNS ce qui permet de créer des domaines et des sous domaines.</p><p>Ainsi nous nous retrouvons avec :</p><ul><li>Une foret, contenant des arbres, contenant des domaines.</li><li>Par analogie : Une foret, contenant des arbres, contenant des feuilles.</li><li>La foret représente l&#39;ensemble des domaines et sous domaines AD.</li><li>Un arbre un domaine avec l&#39;ensemble de ses sous domaines</li><li>Un domaine un seul domaine.</li></ul><p><img src="'+n+'" alt="Représentation d&#39;une foret"></p><p>Plusieurs forets peuvent être liées ensemble au sein d&#39;un &quot;Trust&quot; mais nous verrons cela plus tard.</p><h4 id="les-attributs" tabindex="-1">Les attributs <a class="header-anchor" href="#les-attributs" aria-label="Permalink to &quot;Les attributs&quot;">​</a></h4><p>Chaque objet d&#39;un environnement AD dispose d&#39;attributs. Parmi les plus connus, <em>name</em> pour le nom, <em>sAMccountName</em> pour l&#39;identifiant (Logon) ou encore <em>lastLogon</em> pour la date de dernière connexion.</p><p>Des attributs, il en existe beaucoup, et nous auront l&#39;occasion de nous en servir à différents moments.</p><h4 id="les-droits-des-utilisateurs" tabindex="-1">Les droits des utilisateurs <a class="header-anchor" href="#les-droits-des-utilisateurs" aria-label="Permalink to &quot;Les droits des utilisateurs&quot;">​</a></h4><p>Au sein d&#39;un environnement AD les utilisateurs peuvent avoir différents rôles, ceux-ci sont principalement gérés dans les groupes auxquelles ils appartiennent ainsi qu&#39;aux délégations de droits dont il pourraient bénéficier.</p><p>En pratique, des utilisateurs &quot;lambdas&quot; ne disposent pas de droits particulièrement intéressants pour un attaquant si ce n&#39;est par exemple l&#39;accès à certains partages réseaux ou à certaines applications.</p><p>Des utilisateurs privilégiés sont présent dans le réseau, on parle alors de compte &quot;Administrateur&quot; pour les plus importants d&#39;entre eux. Le groupe &quot;Administrateur du Domaine&quot; regroupe par définition les utilisateurs responsables de l&#39;administration de l&#39;AD.</p><p>Cependant retenez bien que ce titre et l&#39;appartenance à un tel groupe n&#39;est pas la seule option pour obtenir des privilèges importants sur le réseau. Certains utilisateurs sont capables d&#39;effectuer des opérations grâce à des délégations de droits, ou à l&#39;attribution d&#39;un privilège particulier, on parle alors de &quot;Shadow Admin&quot;.</p><p>Ainsi un utilisateur disposant du privilège DCSync est capable d&#39;obtenir une copie des informations de l&#39;AD .. dont la base NTDS.dit, c&#39;est à dire l&#39;empreinte de tous les mots de passe de cet annuaire. Plutôt intéressant pour un attaquant.</p><h3 id="le-gros-defaut-de-microsoft" tabindex="-1">Le gros défaut de Microsoft <a class="header-anchor" href="#le-gros-defaut-de-microsoft" aria-label="Permalink to &quot;Le gros défaut de Microsoft&quot;">​</a></h3><p>Ce titre est volontairement provocateur, mais vous allez vite comprendre l&#39;idée. Nous avons vu plus haut que Microsoft proposait des nouvelles versions de Windows Server et de l&#39;applicatif Active Directory &quot;régulièrement&quot;. Cependant, chacune de ses mises à jour inclus des mécanismes de rétrocompatibilité. Imaginez devoir changer l&#39;ensemble d&#39;un parc informatique parce que la nouvelle version d&#39;Active Directory ne supporte plus l&#39;authentification NTLM, si vous savez de quoi il s&#39;agit vous allez trouver ça bien, mais en pratique c&#39;est ingérable pour les clients de Microsoft. J&#39;écris cet article en 2022 et il m&#39;arrive encore de trouver des machines sous Windows XP / 7 dans les entreprises que je visite. Certaines moutures de Windows ont été créées il y a 15 ans et le code du système d&#39;exploitation ne permet pas d&#39;adopter certaines fonctionnalités de sécurité.</p><p>Ainsi, installer un AD &quot;neuf&quot; en 2022 ne garantie pas que l&#39;ensemble du parc sera protégé, en réalité, le niveau de sécurité dépendra du niveau de la machine la plus faible présente.</p>',34)]))}const q=t(a,[["render",o]]);export{v as __pageData,q as default};
